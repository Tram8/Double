/*
	Ӧ��˵����
	�ڷ���i2cA�豸ǰ�����ȵ��� i2cA_CheckDevice() ���i2cA�豸�Ƿ��������ú���������GPIO
*/
#include "./i2c_BH1750/i2cA_bh1750A_gpio.h"


static void i2cA_BH1750A_GPIOConfig(void);


/*
*********************************************************************************************************
*	�� �� ��: i2cA_Delay
*	����˵��: i2cA����λ�ӳ٣����400KHz
*	��    �Σ���
*	�� �� ֵ: ��
*********************************************************************************************************
*/
static void i2cA_Delay(void)
{
	uint8_t i;

	/*��
	 	�����ʱ����ͨ���߼������ǲ��Եõ��ġ�
    ����������CPU��Ƶ72MHz ��MDK���뻷����1���Ż�
  
		ѭ������Ϊ10ʱ��SCLƵ�� = 205KHz 
		ѭ������Ϊ7ʱ��SCLƵ�� = 347KHz�� SCL�ߵ�ƽʱ��1.5us��SCL�͵�ƽʱ��2.87us 
	 	ѭ������Ϊ5ʱ��SCLƵ�� = 421KHz�� SCL�ߵ�ƽʱ��1.25us��SCL�͵�ƽʱ��2.375us 
	*/
	for (i = 0; i < 10; i++);
}

/*
*********************************************************************************************************
*	�� �� ��: i2cA_Start
*	����˵��: CPU����i2cA���������ź�
*	��    �Σ���
*	�� �� ֵ: ��
*********************************************************************************************************
*/
void i2cA_Start(void)
{
	/* ��SCL�ߵ�ƽʱ��SDA����һ�������ر�ʾi2cA���������ź� */
	BH1750A_i2cA_SDA_1();
	BH1750A_i2cA_SCL_1();
	i2cA_Delay();
	BH1750A_i2cA_SDA_0();
	i2cA_Delay();
	BH1750A_i2cA_SCL_0();
	i2cA_Delay();
}

/*
*********************************************************************************************************
*	�� �� ��: i2cA_Start
*	����˵��: CPU����i2cA����ֹͣ�ź�
*	��    �Σ���
*	�� �� ֵ: ��
*********************************************************************************************************
*/
void i2cA_Stop(void)
{
	/* ��SCL�ߵ�ƽʱ��SDA����һ�������ر�ʾi2cA����ֹͣ�ź� */
	BH1750A_i2cA_SDA_0();
	BH1750A_i2cA_SCL_1();
	i2cA_Delay();
	BH1750A_i2cA_SDA_1();
}

/*
*********************************************************************************************************
*	�� �� ��: i2cA_SendByte
*	����˵��: CPU��i2cA�����豸����8bit����
*	��    �Σ�_ucByte �� �ȴ����͵��ֽ�
*	�� �� ֵ: ��
*********************************************************************************************************
*/
void i2cA_SendByte(uint8_t _ucByte)
{
	uint8_t i;

	/* �ȷ����ֽڵĸ�λbit7 */
	for (i = 0; i < 8; i++)
	{		
		if (_ucByte & 0x80)
		{
			BH1750A_i2cA_SDA_1();
		}
		else
		{
			BH1750A_i2cA_SDA_0();
		}
		i2cA_Delay();
		BH1750A_i2cA_SCL_1();
		i2cA_Delay();	
		BH1750A_i2cA_SCL_0();
		if (i == 7)
		{
			 BH1750A_i2cA_SDA_1(); // �ͷ�����
		}
		_ucByte <<= 1;	/* ����һ��bit */
		i2cA_Delay();
	}
}

/*
*********************************************************************************************************
*	�� �� ��: i2cA_ReadByte
*	����˵��: CPU��i2cA�����豸��ȡ8bit����
*	��    �Σ���
*	�� �� ֵ: ����������
*********************************************************************************************************
*/
uint8_t i2cA_ReadByte(void)
{
	uint8_t i;
	uint8_t value;

	/* ������1��bitΪ���ݵ�bit7 */
	value = 0;
	for (i = 0; i < 8; i++)
	{
		value <<= 1;
		BH1750A_i2cA_SCL_1();
		i2cA_Delay();
		if (BH1750A_i2cA_SDA_READ())
		{
			value++;
		}
		BH1750A_i2cA_SCL_0();
		i2cA_Delay();
	}
	return value;
}

/*
*********************************************************************************************************
*	�� �� ��: i2cA_WaitAck
*	����˵��: CPU����һ��ʱ�ӣ�����ȡ������ACKӦ���ź�
*	��    �Σ���
*	�� �� ֵ: ����0��ʾ��ȷӦ��1��ʾ��������Ӧ
*********************************************************************************************************
*/
uint8_t i2cA_WaitAck(void)
{
	uint8_t re;

	BH1750A_i2cA_SDA_1();	/* CPU�ͷ�SDA���� */
	i2cA_Delay();
	BH1750A_i2cA_SCL_1();	/* CPU����SCL = 1, ��ʱ�����᷵��ACKӦ�� */
	i2cA_Delay();
	if (BH1750A_i2cA_SDA_READ())	/* CPU��ȡSDA����״̬ */
		re = 1;
	else
		re = 0;
	BH1750A_i2cA_SCL_0();
	i2cA_Delay();
	return re;
}

/*
*********************************************************************************************************
*	�� �� ��: i2cA_Ack
*	����˵��: CPU����һ��ACK�ź�
*	��    �Σ���
*	�� �� ֵ: ��
*********************************************************************************************************
*/
void i2cA_Ack(void)
{
	BH1750A_i2cA_SDA_0();	/* CPU����SDA = 0 */
	i2cA_Delay();
	BH1750A_i2cA_SCL_1();	/* CPU����1��ʱ�� */
	i2cA_Delay();
	BH1750A_i2cA_SCL_0();
	i2cA_Delay();
	BH1750A_i2cA_SDA_1();	/* CPU�ͷ�SDA���� */
}

/*
*********************************************************************************************************
*	�� �� ��: i2cA_NAck
*	����˵��: CPU����1��NACK�ź�
*	��    �Σ���
*	�� �� ֵ: ��
*********************************************************************************************************
*/
void i2cA_NAck(void)
{
	BH1750A_i2cA_SDA_1();	/* CPU����SDA = 1 */
	i2cA_Delay();
	BH1750A_i2cA_SCL_1();	/* CPU����1��ʱ�� */
	i2cA_Delay();
	BH1750A_i2cA_SCL_0();
	i2cA_Delay();	
}

/*
*********************************************************************************************************
*	�� �� ��: i2cA_BH1750A_GPIOConfig
*	����˵��: ����i2cA���ߵ�GPIO������ģ��IO�ķ�ʽʵ��
*	��    �Σ���
*	�� �� ֵ: ��
*********************************************************************************************************
*/
static void i2cA_BH1750A_GPIOConfig(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;

	RCC_APB2PeriphClockCmd(BH1750A_RCC_i2cA_PORT, ENABLE);	/* ��GPIOʱ�� */

	GPIO_InitStructure.GPIO_Pin = BH1750A_i2cA_SCL_PIN | BH1750A_i2cA_SDA_PIN;
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_OD;  	/* ��©��� */
	GPIO_Init(BH1750A_GPIO_PORT_i2cA, &GPIO_InitStructure);

	/* ��һ��ֹͣ�ź�, ��λi2cA�����ϵ������豸������ģʽ */
	i2cA_Stop();
}

/*
*********************************************************************************************************
*	�� �� ��: i2cA_CheckDevice
*	����˵��: ���i2cA�����豸��CPU�����豸��ַ��Ȼ���ȡ�豸Ӧ�����жϸ��豸�Ƿ����
*	��    �Σ�_Address���豸��i2cA���ߵ�ַ
*	�� �� ֵ: ����ֵ 0 ��ʾ��ȷ�� ����1��ʾδ̽�⵽
*********************************************************************************************************
*/
uint8_t i2cA_CheckDevice(uint8_t _Address)
{
	uint8_t ucAck;

	i2cA_BH1750A_GPIOConfig();		/* ����GPIO */

	i2cA_Start();		/* ���������ź� */

	/* �����豸��ַ+��д����bit��0 = w�� 1 = r) bit7 �ȴ� */
	i2cA_SendByte(_Address | BH1750A_i2cA_WR);
	ucAck = i2cA_WaitAck();	/* ����豸��ACKӦ�� */

	i2cA_Stop();			/* ����ֹͣ�ź� */

	return ucAck;
}
